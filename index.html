<!DOCTYPE html>
<html lang="ar" dir="rtl" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أ.د. عطية عبد العزيز الفرجاني | أستاذ وباحث في هندسة القوى الكهربائية</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --bg-color: #f3f4f6; --bg-secondary-color: #ffffff; --text-color: #1f2937;
            --text-secondary-color: #4b5563; --primary-color: #0d9488; --primary-hover-color: #0f766e;
            --border-color: #e5e7eb;
        }
        html.dark {
            --bg-color: #111827; --bg-secondary-color: #1f2937; --text-color: #f9fafb;
            --text-secondary-color: #9ca3af; --border-color: #374151;
        }
        /* Base styles */
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; cursor: none; overflow-x: hidden;}
        .text-primary { color: var(--primary-color); } .bg-primary { background-color: var(--primary-color); }
        .bg-secondary { background-color: var(--bg-secondary-color); }
        
        /* Preloader Redesign v2 */
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 10000; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 1.5rem; transition: opacity 0.8s ease-out 0.5s, visibility 0.8s ease-out 0.5s; }
        #preloader.loaded { opacity: 0; visibility: hidden; }
        .loader-logo-a { width: 100px; height: 100px; opacity: 0; animation: fadeIn 1s ease-out forwards; }
        .loader-logo-a .logo-path-a { stroke: var(--primary-color); stroke-width: 8; fill: none; stroke-linecap: round; stroke-linejoin: round; stroke-dasharray: 250; stroke-dashoffset: 250; animation: draw-logo-a 2s ease-in-out 0.5s forwards; }
        .preloader-text-a { font-size: 1.5rem; font-weight: 700; color: var(--text-color); opacity: 0; animation: fadeInUp 1s ease-out 1.5s forwards; }
        #preloader-progress-bar-container { width: 150px; height: 4px; background-color: var(--border-color); border-radius: 2px; overflow: hidden; opacity: 0; animation: fadeIn 1s ease-out 0.5s forwards; }
        #preloader-progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--primary-hover-color)); border-radius: 2px; animation: fill-progress 2s ease-in-out 0.5s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes draw-logo-a { to { stroke-dashoffset: 0; } }
        @keyframes fill-progress { from { width: 0%; } to { width: 100%; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Cursor, Scrollbar */
        .cursor { width: 25px; height: 25px; border: 2px solid var(--primary-color); border-radius: 50%; position: fixed; pointer-events: none; z-index: 9999; transform: translate(-50%, -50%); transition: all 0.1s ease-out; }
        #scroll-progress-bar { position: fixed; top: 0; right: 0; height: 3px; background-color: var(--primary-color); width: 0%; z-index: 100; }
        
        /* Header */
        .nav-active { color: var(--primary-color) !important; font-weight: 700; }
        #rgb-clock { font-weight: bold; animation: rgb-glow 5s infinite linear; }
        @keyframes rgb-glow { 0% { color: #ff2a2a; text-shadow: 0 0 5px #ff2a2a; } 16% { color: #ff7a2a; text-shadow: 0 0 5px #ff7a2a; } 33% { color: #f0ff2a; text-shadow: 0 0 5px #f0ff2a; } 50% { color: #2aff9d; text-shadow: 0 0 5px #2aff9d; } 66% { color: #2a7fff; text-shadow: 0 0 5px #2a7fff; } 83% { color: #a22aff; text-shadow: 0 0 5px #a22aff; } 100% { color: #ff2a2a; text-shadow: 0 0 5px #ff2a2a; } }

        /* Theme Toggle Switch */
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 44px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        .slider .fa-moon, .slider .fa-sun { position: absolute; top: 5px; color: #fff; font-size: 14px; transition: opacity 0.4s; }
        .slider .fa-moon { left: 5px; opacity: 0; }
        .slider .fa-sun { right: 5px; opacity: 1; }
        input:checked + .slider .fa-moon { opacity: 1; }
        input:checked + .slider .fa-sun { opacity: 0; }
        
        /* Hero section and background */
        #bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #hero > div { z-index: 2; position: relative; }

        /* Word Reveal Animation */
        .g-title { display: block; overflow: hidden;}
        .g-title .word { transform: translateY(115%); transition: transform .5s; display: inline-block; padding-left: 4px;}

        /* Chatbot Redesign */
        #chat-widget { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        #chat-bubble { width: 60px; height: 60px; background: linear-gradient(45deg, var(--primary-color), var(--primary-hover-color)); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 5px 20px rgba(13, 148, 136, 0.4); animation: bubble-pulse 2.5s infinite; transition: transform 0.3s ease; }
        @keyframes bubble-pulse { 0%, 100% { transform: scale(1); box-shadow: 0 5px 20px rgba(13, 148, 136, 0.4); } 50% { transform: scale(1.05); box-shadow: 0 8px 30px rgba(13, 148, 136, 0.6); } }
        #chat-bubble:hover { transform: scale(1.15) rotate(10deg); animation-play-state: paused; }
        #chat-window { position: absolute; bottom: 80px; right: 0; width: 370px; max-width: 90vw; height: 550px; max-height: 75vh; background-color: var(--bg-secondary-color); border: 1px solid var(--border-color); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; transform-origin: bottom right; transform: scale(0.5); opacity: 0; pointer-events: none; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease; }
        #chat-window.open { transform: scale(1); opacity: 1; pointer-events: auto; }
        #chat-header { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-color); background: var(--bg-color); }
        #chat-header img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary-color); }
        #chat-header h3 { font-weight: 700; font-size: 1.1rem; color: var(--text-color); }
        #chat-messages { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .message { padding: 10px 15px; border-radius: 18px; max-width: 85%; line-height: 1.6; animation: message-in 0.3s ease; }
        @keyframes message-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { background: var(--primary-color); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .message.ai { background: var(--bg-color); color: var(--text-color); align-self: flex-start; border-bottom-left-radius: 4px; }
        #chat-messages .message.ai { display: flex; gap: 10px; align-items: flex-start;}
        #chat-messages .message.ai img { width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0; margin-top: 5px;}
        .message p, .message ul, .message ol { margin-bottom: 0.5rem; }
        .message ul, .message ol { padding-right: 1.2rem; }
        .message strong { color: var(--primary-color); }
        .message code { background-color: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        html.dark .message code { background-color: rgba(255,255,255,0.1); }
        #chat-quick-replies { padding: 0 15px 10px; display: flex; flex-wrap: wrap; gap: 8px; }
        .quick-reply-btn { background: var(--bg-color); border: 1px solid var(--border-color); color: var(--primary-color); padding: 6px 14px; font-size: 0.8rem; border-radius: 20px; cursor: pointer; transition: all 0.2s; }
        .quick-reply-btn:hover { background-color: var(--primary-color); color: white; border-color: var(--primary-color); transform: translateY(-2px); }
        #chat-input-wrapper { display: flex; align-items: center; gap: 10px; padding: 10px 15px; border-top: 1px solid var(--border-color); }
        #chat-input { flex-grow: 1; border: none; background: transparent; padding: 10px; color: var(--text-color); outline: none; font-size: 1rem; }
        #chat-send-btn { background: none; color: var(--primary-color); border: none; font-size: 1.5rem; cursor: pointer; transition: transform 0.2s ease; display: flex; align-items: center; justify-content: center; padding: 5px; }
        #chat-send-btn:hover { transform: scale(1.15) rotate(5deg); }
    </style>
</head>
<body>
    <!-- This is the main body of the website -->
    <div id="scroll-progress-bar"></div>
    <div id="preloader">
        <div class="loader-logo-a">
            <svg viewBox="0 0 100 100">
                <path class="logo-path-a" d="M20,80 L50,20 L80,80 M32,65 L68,65"></path>
            </svg>
        </div>
        <div id="preloader-progress-bar-container">
            <div id="preloader-progress-bar"></div>
        </div>
        <div class="preloader-text-a">أ.د. عطية الفرجاني</div>
    </div>
    <div class="cursor"></div>

    <header class="bg-secondary/80 backdrop-blur-sm shadow-md fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="#hero" class="text-xl md:text-2xl font-bold text-primary">أ.د. عطية الفرجاني</a>
                <div id="rgb-clock" class="hidden md:block tabular-nums text-sm"></div>
            </div>
            
            <nav id="main-nav" class="hidden lg:flex items-center space-x-6 space-x-reverse text-text-color">
                <a href="#hero" class="nav-link hover:text-primary transition-colors">الرئيسية</a>
                <a href="#about" class="nav-link hover:text-primary transition-colors">السيرة الذاتية</a>
                <a href="#services" class="nav-link hover:text-primary transition-colors">الاهتمامات البحثية</a>
                <a href="#contact" class="nav-link hover:text-primary transition-colors">تواصل</a>
            </nav>
            
            <div class="flex items-center space-x-3 space-x-reverse">
                 <div class="theme-switch-wrapper">
                    <label class="theme-switch" for="theme-checkbox">
                        <input type="checkbox" id="theme-checkbox" />
                        <div class="slider">
                            <i class="fas fa-moon"></i><i class="fas fa-sun"></i>
                        </div>
                    </label>
                 </div>
                 <a href="#contact" class="hidden md:block bg-primary text-white font-bold text-sm py-2 px-4 rounded-full hover:bg-primary-hover transition-all transform hover:scale-105">تواصل</a>
                 <button id="mobile-menu-button" class="lg:hidden text-2xl text-text-color"><i class="fas fa-bars"></i></button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden lg:hidden bg-secondary/95 backdrop-blur-sm p-4">
            <div class="flex justify-between items-center mb-4 text-sm text-text-secondary-color">
                <div id="mobile-rgb-clock" class="tabular-nums"></div>
                 <a href="#contact" class="nav-link-mobile bg-primary text-white font-bold text-sm py-2 px-4 rounded-full">تواصل</a>
            </div>
            <a href="#hero" class="nav-link-mobile block text-center py-3 text-lg hover:bg-primary hover:text-white rounded-lg">الرئيسية</a>
            <a href="#about" class="nav-link-mobile block text-center py-3 text-lg hover:bg-primary hover:text-white rounded-lg">السيرة الذاتية</a>
            <a href="#services" class="nav-link-mobile block text-center py-3 text-lg hover:bg-primary hover:text-white rounded-lg">الاهتمامات البحثية</a>
            <a href="#contact" class="nav-link-mobile block text-center py-3 text-lg hover:bg-primary hover:text-white rounded-lg">تواصل</a>
        </div>
    </header>

    <main>
        <!-- Hero Section -->
        <section id="hero" class="min-h-screen flex items-center bg-secondary relative overflow-hidden">
            <canvas id="bg-canvas"></canvas>
            <div class="container mx-auto px-6 text-center">
                <h1 class="text-4xl md:text-7xl font-black leading-tight reveal">أنا الأستاذ الدكتور <span class="text-primary">عطية الفرجاني</span></h1>
                <p class="text-xl md:text-3xl mt-4 text-text-secondary-color reveal" data-delay="0.2">باحث وأكاديمي متخصص في هندسة القوى الكهربائية.</p>
            </div>
        </section>

        <!-- About Section -->
        <section id="about" class="py-24 bg-color">
             <div class="container mx-auto px-6">
                <div class="text-center mb-16"> <h2 class="text-4xl font-bold g-title" data-text="مسيرة علمية حافلة"></h2> </div>
                <div class="flex flex-col lg:flex-row items-center gap-12">
                    <div class="lg:w-1/2 reveal">
                        <img src="https://i1.rgstatic.net/ii/profile.image/272311438188554-1441935634812_Q512/Attia-El-Fergany.jpg" alt="الأستاذ الدكتور عطية الفرجاني" class="rounded-lg shadow-2xl mx-auto w-full max-w-md object-cover">
                    </div>
                    <div class="lg:w-1/2 text-center lg:text-right reveal" data-delay="0.2">
                        <p class="text-xl leading-relaxed mb-6">الأستاذ الدكتور عطية الفرجاني هو شخصية أكاديمية وبحثية بارزة في مجال هندسة القوى الكهربائية في مصر والعالم. يشغل حاليًا منصب أستاذ ورئيس قسم هندسة القوى والآلات الكهربية بكلية الهندسة، جامعة الزقازيق. يُعرف بإسهاماته البحثية الغزيرة، خاصة في مجال تطبيق التقنيات الذكية لتحسين أداء أنظمة القوى الكهربائية، وقد تم تصنيفه ضمن أفضل 2% من العلماء الأكثر تأثيرًا على مستوى العالم وفقًا لتصنيف جامعة ستانفورد لعدة سنوات متتالية.</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Services/Research Interests Section -->
        <section id="services" class="py-24 bg-secondary">
            <div class="container mx-auto px-6">
                <div class="text-center mb-16"> <h2 class="text-4xl font-bold g-title" data-text="الاهتمامات البحثية"></h2> </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            </div>
        </section>
        
        <!-- Contact Section -->
        <section id="contact" class="py-24 bg-color">
             <div class="container mx-auto px-6 text-center">
                 <div class="text-center mb-16">
                    <h2 class="text-4xl font-bold g-title mb-4" data-text="للتواصل العلمي والأكاديمي"></h2>
                    <p class="text-lg text-text-secondary-color mt-4 reveal" data-delay="0.2">للاستفسارات البحثية أو التعاون الأكاديمي، يمكنكم التواصل عبر القنوات التالية.</p>
                </div>
                <div class="flex flex-col md:flex-row justify-center items-center gap-6 reveal" data-delay="0.4">
                    <a href="mailto:el_fergany@zu.edu.eg" class="bg-primary text-white font-bold text-lg md:text-xl py-3 px-8 rounded-lg hover:bg-primary-hover transition-all duration-300 transform hover:scale-105 inline-flex items-center gap-2">
                        <i class="fas fa-paper-plane"></i> el_fergany@zu.edu.eg
                    </a>
                    <a href="tel:+201005705526" class="bg-secondary text-text-color font-bold text-lg md:text-xl py-3 px-8 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-300 transform hover:scale-105 inline-flex items-center gap-3 border border-border-color">
                        <i class="fas fa-phone"></i> 01005705526
                    </a>
                </div>
                <div class="flex justify-center space-x-6 space-x-reverse mt-8 reveal" data-delay="0.6">
                    <a href="https://www.linkedin.com/in/attia-el-fergany-38422a55" target="_blank" class="magnetic-icon text-text-secondary-color hover:text-blue-700" title="LinkedIn Profile"><i class="fab fa-linkedin fa-2x"></i></a>
                    <a href="https://orcid.org/0000-0003-3476-1361" target="_blank" class="magnetic-icon text-text-secondary-color hover:text-green-500" title="ORCID Profile"><i class="fab fa-orcid fa-2x"></i></a>
                    <a href="http://www.eng.zu.edu.eg/faculty/sector_info?d=1560" target="_blank" class="magnetic-icon text-text-secondary-color hover:text-primary" title="ملف الكلية"><i class="fas fa-university fa-2x"></i></a>
                    <a href="https://scholar.google.com/citations?user=PPAXoJkAAAAJ" target="_blank" class="magnetic-icon text-text-secondary-color hover:text-blue-600" title="Google Scholar"><i class="fas fa-graduation-cap fa-2x"></i></a>
                </div>
             </div>
        </section>
    </main>
    
    <footer class="bg-gray-900 text-gray-400 py-6"><div class="container mx-auto px-6 text-center"><p>© 2024 | جميع الحقوق محفوظة | <span class="font-bold text-primary">أ.د. عطية الفرجاني</span></p></div></footer>
    
    <!-- Chatbot Widget -->
    <div id="chat-widget">
        <div id="chat-window">
            <div id="chat-header">
                <img src="https://i1.rgstatic.net/ii/profile.image/272311438188554-1441935634812_Q512/Attia-El-Fergany.jpg" alt="AI Avatar">
                <h3>المساعد الأكاديمي</h3>
            </div>
            <div id="chat-messages"></div>
            <div id="chat-quick-replies"></div>
            <div id="chat-input-wrapper">
                <input id="chat-input" type="text" placeholder="اطرح سؤالاً..." autocomplete="off">
                <button id="chat-send-btn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        <div id="chat-bubble"><i class="fas fa-robot fa-2x text-white"></i></div>
    </div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {
    // This script is responsible for all the dynamic functionality of the website.
    const docHtml = document.documentElement;

    // --- Preloader ---
    const preloader = document.getElementById('preloader');
    setTimeout(() => {
        if (preloader) preloader.classList.add('loaded');
    }, 2800); // Adjusted duration for new animation

    // --- Header Features ---
    const clockEl = document.getElementById('rgb-clock');
    const mobileClockEl = document.getElementById('mobile-rgb-clock');
    const progressBar = document.getElementById('scroll-progress-bar');

    function updateHeader() {
        const now = new Date();
        const options = { timeZone: 'Africa/Cairo', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
        const timeString = now.toLocaleTimeString('en-US', options);
        if (clockEl) clockEl.textContent = timeString;
        if (mobileClockEl) mobileClockEl.textContent = timeString;
        
        if (progressBar) {
            const scrollTotal = docHtml.scrollHeight - docHtml.clientHeight;
            progressBar.style.width = `${(window.scrollY / scrollTotal) * 100}%`;
        }
    }
    setInterval(updateHeader, 1000);
    window.addEventListener('scroll', updateHeader);
    updateHeader();

    // --- Theme Switcher ---
    const themeCheckbox = document.getElementById('theme-checkbox');
    function applyTheme(theme) {
        docHtml.classList.remove('light', 'dark');
        docHtml.classList.add(theme);
        localStorage.setItem('theme', theme);
    }
    const currentTheme = localStorage.getItem('theme') || 'light';
    applyTheme(currentTheme);
    if (currentTheme === 'dark') themeCheckbox.checked = true;
    
    themeCheckbox.addEventListener('change', () => {
        applyTheme(themeCheckbox.checked ? 'dark' : 'light');
    });

    // --- GSAP Word and Reveal Animations ---
    gsap.registerPlugin(ScrollTrigger);
    document.querySelectorAll(".g-title").forEach(title => {
        if(title.dataset.text) {
            const words = title.dataset.text.split(/(\s|,|\?)/);
            title.textContent = "";
            words.forEach(word => {
                if (word.trim().length > 0) {
                    const span = document.createElement("span");
                    span.className = "word";
                    span.textContent = word;
                    title.appendChild(span);
                } else {
                     title.appendChild(document.createTextNode(word));
                }
            });
            gsap.from(title.querySelectorAll(".word"), {
                y: '115%', stagger: 0.1, duration: 0.5, ease: 'power3.out',
                scrollTrigger: { trigger: title, start: "top 90%", toggleActions: "play none none none" }
            });
        }
    });

    document.querySelectorAll(".reveal").forEach(el => {
        gsap.fromTo(el, 
            { opacity: 0, y: 50 },
            { 
                opacity: 1, y: 0, duration: 0.8, ease: 'power3.out',
                delay: parseFloat(el.dataset.delay) || 0,
                scrollTrigger: { trigger: el, start: "top 90%", toggleActions: "play none none none" }
            }
        );
    });

    // --- Research Interests Cards ---
    const services = [
        { icon: 'fa-microchip', title: 'تطبيق التقنيات الذكية', desc: 'استخدام خوارزميات الذكاء الاصطناعي والتحسين لحل المشكلات المعقدة في أنظمة القوى الكهربائية.' },
        { icon: 'fa-solar-panel', title: 'الطاقة المتجددة والشبكات الذكية', desc: 'تحليل وتصميم أنظمة الطاقة المتجددة ودمجها بكفاءة في الشبكات الكهربائية الحديثة.' },
        { icon: 'fa-award', title: 'إسهامات علمية معترف بها', desc: 'نشر مئات الأبحاث وتصنيفه ضمن أفضل 2% من العلماء عالمياً، مما يعكس تأثيره الكبير في مجاله.' }
    ];
    const servicesContainer = document.querySelector('#services .grid');
    if (servicesContainer) {
        servicesContainer.innerHTML = services.map((service, index) => `
            <div class="bg-color p-8 rounded-lg shadow-lg transition-all duration-300 hover:shadow-2xl hover:-translate-y-2 reveal" data-delay="${index * 0.2}">
                <i class="fas ${service.icon} fa-3x text-primary mb-4"></i>
                <h3 class="text-2xl font-bold mb-2">${service.title}</h3>
                <p class="text-text-secondary-color">${service.desc}</p>
            </div>
        `).join('');
    }
    
    // --- Nav & Mobile Menu Logic ---
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
    document.querySelectorAll('.nav-link-mobile, .nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
            if(link.classList.contains('nav-link-mobile')) {
                mobileMenu.classList.add('hidden');
            }
            const targetId = link.getAttribute('href');
            if(document.querySelector(targetId)) {
               e.preventDefault();
               document.querySelector(targetId).scrollIntoView({ behavior: 'smooth' });
            }
        });
    });

    const navLinks = document.querySelectorAll('#main-nav .nav-link');
    const pageSections = document.querySelectorAll('main section');
    function updateActiveLink() {
        let current = pageSections[0]?.id || '';
        pageSections.forEach(section => {
            if (window.scrollY >= section.offsetTop - 150) current = section.id;
        });
        navLinks.forEach(link => {
            link.classList.remove('nav-active');
            if (link.getAttribute('href') === '#' + current) link.classList.add('nav-active');
        });
    }
    window.addEventListener('scroll', updateActiveLink);
    updateActiveLink();

    // --- Gemini AI Chatbot for Dr. Attia ---
    const chatWidget = {
        bubble: document.getElementById('chat-bubble'),
        window: document.getElementById('chat-window'),
        messages: document.getElementById('chat-messages'),
        input: document.getElementById('chat-input'),
        sendBtn: document.getElementById('chat-send-btn'),
        quickReplies: document.getElementById('chat-quick-replies'),
        apiKey: 'AIzaSyD39lIpfEjoPYM6NcOxWtM3pQym9ZrkXfo', // The provided Gemini API Key
        history: [], 

        init() {
            this.bubble.addEventListener('click', () => this.toggle());
            this.sendBtn.addEventListener('click', () => this.sendMessage());
            this.input.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.sendMessage(); } });
        },
        toggle() { 
            this.window.classList.toggle('open');
            if(this.window.classList.contains('open') && this.messages.children.length === 0) {
                 this.addMessage("أهلاً بك. أنا المساعد الرقمي للأستاذ الدكتور عطية الفرجاني. كيف يمكنني خدمتك اليوم في الأمور الأكاديمية والبحثية؟", 'ai');
                 this.showQuickReplies([
                     "من هو د. عطية الفرجاني؟", 
                     "ما هي اهتماماته البحثية؟", 
                     "هل يشرف على طلاب دراسات عليا؟",
                     "ما هي أحدث أبحاثه؟"
                    ]);
            }
        },
        sendMessage() {
            const userMessage = this.input.value.trim();
            if (!userMessage) return;
            this.addMessage(userMessage, 'user');
            this.input.value = '';
            this.quickReplies.innerHTML = '';
            this.getAIResponse(userMessage);
        },
        sendQuickReply(text) {
            this.addMessage(text, 'user');
            this.quickReplies.innerHTML = '';
            this.getAIResponse(text);
        },
        addMessage(content, type) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            if (type === 'ai') {
                const avatar = `<img src="https://i1.rgstatic.net/ii/profile.image/272311438188554-1441935634812_Q512/Attia-El-Fergany.jpg" alt="AI Avatar">`;
                const textContent = `<div>${marked.parse(content)}</div>`;
                div.innerHTML = avatar + textContent;
            } else {
                // For user messages, we just set the text content
                div.textContent = content;
            }
            this.messages.appendChild(div);
            this.messages.scrollTop = this.messages.scrollHeight;
        },
        showQuickReplies(replies) {
            this.quickReplies.innerHTML = '';
            replies.forEach(text => {
                const btn = document.createElement('button');
                btn.className = 'quick-reply-btn';
                btn.textContent = text;
                btn.onclick = () => this.sendQuickReply(text);
                this.quickReplies.appendChild(btn);
            });
        },
        
        async getAIResponse(prompt) {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message ai';
            loadingDiv.innerHTML = `<img src="https://i1.rgstatic.net/ii/profile.image/272311438188554-1441935634812_Q512/Attia-El-Fergany.jpg" alt="AI Avatar"><div><span class="animate-pulse">لحظات، أفكر في إجابة...</span></div>`;
            this.messages.appendChild(loadingDiv);
            this.messages.scrollTop = this.messages.scrollHeight;

            const systemPrompt = `أنت مساعد ذكاء اصطناعي أكاديمي للأستاذ الدكتور عطية عبد العزيز الفرجاني. اسمك 'المساعد الأكاديمي'. ردودك يجب أن تكون باللغة العربية الفصحى، دقيقة، رسمية، ومفيدة. استخدم المعلومات التالية عن الدكتور عطية: 'هو شخصية أكاديمية وبحثية بارزة، أستاذ ورئيس قسم هندسة القوى والآلات الكهربية بجامعة الزقازيق. حاصل على البكالوريوس (1994)، الماجستير (1998)، والدكتوراه (2001) من جامعة الزقازيق. تم تصنيفه ضمن أفضل 2% من العلماء الأكثر تأثيرًا عالميًا (تصنيف ستانفورد). اهتماماته البحثية تشمل تطبيق التقنيات الذكية، الطاقة المتجددة، جودة الطاقة، وخلايا الوقود. له مئات الأبحاث المنشورة دوليًا، وهو عضو أول في IEEE وعضو في IET. يمكن التواصل معه عبر البريد الإلكتروني (el_fergany@zu.edu.eg)، الهاتف (01005705526)، أو ملفه الشخصي على LinkedIn.' هدفك هو تقديم معلومات دقيقة عن مسيرته الأكاديمية، أبحاثه، وإنجازاته. تجنب استخدام اللغة العامية. لا تذكر أنك نموذج لغوي كبير أو تذكر اسم الشركة التي طورتك.`;

            this.history.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: [
                    { role: "model", parts: [{ text: systemPrompt }] },
                    ...this.history
                ]
            };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const data = await response.json();
                this.messages.removeChild(loadingDiv);
                
                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content.parts[0].text) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    this.addMessage(aiText, 'ai');
                    this.history.push({ role: "model", parts: [{ text: aiText }] });
                } else {
                    this.addMessage("عفواً، لم أتمكن من العثور على إجابة. يرجى إعادة صياغة السؤال.", 'ai');
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                this.messages.removeChild(loadingDiv);
                this.addMessage("عفواً، حدث خطأ فني. يرجى المحاولة مرة أخرى لاحقًا.", 'ai');
            } finally {
                // Show new, more relevant quick replies after a response
                this.showQuickReplies(["حدثني عن تصنيف ستانفورد", "ما هي أبرز منشوراته؟", "كيف يمكن التعاون معه بحثياً؟"]);
                // Keep history concise
                if (this.history.length > 10) {
                    this.history = this.history.slice(-10); 
                }
            }
        }
    };
    chatWidget.init();
    
    // --- 3D Background ---
    try {
        let scene = new THREE.Scene();
        let camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        let renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        let stars = [];
        for (let i = 0; i < 1000; i++) {
            let star = new THREE.Vector3(
                THREE.MathUtils.randFloatSpread(2000),
                THREE.MathUtils.randFloatSpread(2000),
                THREE.MathUtils.randFloatSpread(2000)
            );
            stars.push(star);
        }
        let starGeo = new THREE.BufferGeometry().setFromPoints(stars);
        let starMat = new THREE.PointsMaterial({ color: 0xaaaaaa, size: 0.7 });
        let starField = new THREE.Points(starGeo, starMat);
        scene.add(starField);
        camera.position.z = 1;
        function animate() {
            requestAnimationFrame(animate);
            starField.rotation.y += 0.0002;
            renderer.render(scene, camera);
        }
        animate();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    } catch(e) {
        console.error("Three.js background failed to load.", e);
    }
});
</script>
</body>
</html>


